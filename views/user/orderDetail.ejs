<%- include("../partials/homeHeader") %>
<%- include("../partials/mainHeader") %>

<style>
    .order-status {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
  }
  .order-status .step {
    text-align: center;
    flex: 1;
  }
  .step .icon {
    width: 30px;
    height: 30px;
    background-color: #6c63ff;
    border-radius: 50%;
    display: inline-block;
  }
  .step p {
    margin-top: 10px;
    font-weight: bold;
  }
  .order-item img {
    max-width: 100px;
    margin-right: 15px;
  }
  .order-item {
    display: flex;
    align-items: center;
  }
  .order-summary {
    border-left: 1px solid #ddd;
    padding-left: 20px;
  }
  .card-equal {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .equal-height-row {
    display: flex;
    align-items: stretch;
  }
  .textColor{
    color: black;
  }
</style>

<body>
  <div class="container mt-4">
    <!-- Delivery Address Section -->
    <div class=" mb-4 container"> 
      <h5 class="font-weight-bold mb-2 text-danger">Delivery Address</h5>
      <div id="currAddress" class="col-lg-5 mb-2 px-4 py-4 saved-address ">
        <div class="d-flex justify-content-between mb-3">
          <span class="font-weight-bold text-uppercase"><%= user.firstName %></span>
        </div>
        <div><%= order.address[0].house %></div>
        <div><%= order.address[0].city %></div>
        <div><%= order.address[0].district %>-<%=order.address[0].pin%></div>
        <div class="mt-2">Mobile: <span class="font-weight-bold"><%= order.address[0].phone %></span></div>
        <div><%= user.email || '' %></div>
        <hr>
      </div>
    </div>
  
    <!-- Order Items Section -->
    <h5 class="font-weight-bold mb-1 text-danger container">Order Detail</h5>
    <% order.products.forEach((product)=>{ %>
    <div class="box-shadow col-lg-12 d-flex container p-0 my-4">
      <div class="row align-items-center">
        <div class="col-lg-4 p-0">
          <img class="img" src="/public/product_img/<%= product.image %>" alt="" style="height: 400px;width: 950px;">
        </div>
        <div class="col-lg-8">
          <h5 class="mt-3 text-center font-weight-bold   mb-5" style="color: black;"><%= product.name %></h5>
          <div class="d-flex justify-content-between font-weight-bold my-4">
            <div>Amount</div>
            <div>Quantity</div>
            <div>Total</div>
            <div>Order Status</div>
          </div>
          <div class="d-flex justify-content-between font-weight-bold">
            <div>
              <span class="mr-2">₹<%= product.price %></span>
              <span class="text text-danger"  style="text-decoration: line-through;">₹<%= product.productId.price %></span>
            </div>
            <div><%= product.quantity %></div>
            <div>₹<%= product.price %></div>
            <div class="badge 
              <% if (product.status === 'Delivered') { %> 
              badge-success 
              <% } else if (product.status === 'Canceled') { %> 
              badge-danger 
              <% } else if (product.status === 'Pending') { %> 
              badge-warning
              <% } else { %> 
              badge-primary 
              <% } %>">
              <%= product.status %>
            </div>
          </div>
          <hr>
          <div class="font-weight-bold">
            <div class="mt-3 mb-2">Payment Status:</div>
            <% if (product.status === 'Delivered') { %>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#returnModal">Return</button>
            <% } else if (product.status === 'Pending') { %>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">Cancel</button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% })%>
  
    <!-- Total Amount Section -->
    <div class="d-flex justify-content-end container">
      <div class="checkout__order mb-4"> 
        <h4 class="order__title">Your Order</h4>
        <ul class="checkout__total__all border-top-0">
          <li>Total MRP <span class="order_summary">₹ <%= order.totalAmount + order.discounted_price %></span></li>
          <li>Discount on MRP <span class="text-success">₹ <%= order.discounted_price %></span></li>
          <li>Coupon Discount <span class="text-success">₹ <%= order.discounted_price %></span></li>
          <li>Total Amount <span>₹ <%= order.totalAmount %></span></li>
        </ul>
  
        <div class="mt-3 mb-2">Payment Status:</div>
        <div class="mt-3"> 
          <button class="btn-primary text-white border-0 mr-2">
            <i class="fas fa-money-check"></i> Online
          </button>
        </div>
        <div class="mt-3">
          <a href="/download-invoice/<%= product._id %>" class="btn btn-dark">Invoice Download</a>
        </div>
      </div>
    </div>
  </div>
  
  <%- include("../partials/mainFooter") %>

<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelModalLabel">Cancel Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="cancelForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="cancelReason" class="form-label">Reason</label>
            <textarea id="cancelReason" name="cancelReason" rows="5" cols="40" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="returnModalLabel">Return Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="returnForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="returnReason" class="form-label">Reason</label>
            <textarea id="reason" name="returnReason" rows="5" cols="40" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" >Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
document.getElementById('returnForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // Prevent the form from submitting the traditional way

    let reason = document.getElementById('reason').value;
    let productId = '<%= product._id %>'; // Get the product ID from your template (EJS)
  
    
    try {
        let response = await fetch(`/return/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ returnReason: reason }) // Send the reason in the body
        });

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Your return request has been submitted.',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = '/orders'; // Redirect after showing success
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Network error or request failed.',
            confirmButtonText: 'OK'
        });
    }
});


document.getElementById('cancelForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // Prevent the form from submitting the traditional way

    let reason = document.getElementById('cancelReason').value;
    let quantity = '<%= product.quantity %>';
    let productId = '<%= product._id %>';  
     

    try {
        let response = await fetch(`/cancelOrder/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ returnReason: reason, quantity })  
        });

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Cancelled!',
                text: 'Your Order has been Cancelled.',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = '/orders';  
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Network error or request failed.',
            confirmButtonText: 'OK'
        });
    }
});

</script>
<%- include("../partials/homeFooter") %>
