<%- include('../partials/adminHeader') %>
<style>
    html, body {
    height: 100%;
    margin: 0;
}

.container-fluid {
    display: flex;
}

.sidebar {
    height: 100vh; /* Make sidebar full height */
    background-color: #000000; /* Change this to your desired background color */
}

.main-content {
    flex-grow: 1; /* Allow main content to take remaining space */
    padding: 20px; /* Add padding as needed */
}
 
</style>
<div class="container-fluid ">
    <div class="row flex-grow-1">
        <!-- Sidebar on the left side -->
        <nav class="col-md-2 sidebar sidebar-offcanvas " id="sidebar">
            <div class="user-profile">
                 
                <div class="user-name adminName">
                   Prajwal
                </div>
                <div class="user-designation">
                    Admin
                </div>
              </div>
            <%- include('../partials/adminSidebar') %>
        </nav>

        <!-- Main content area for the sales report -->
        <div class="col-md-10 main-content">
            <h4 class="mb-3 font-weight-bold">Sales Report</h4>

            <!-- Filter dropdown -->
            <select name="" class="form-select w-25 mb-3" id="filterType" onchange="handleFilterChange()">
                <option value="all">All</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
                <option value="custom">Custom</option>
            </select>

            <!-- Buttons for downloading PDF and Excel -->
            <div class="d-flex justify-content-end gap-4 mb-3">
                <button class="p-2 text-white border-0 mr-4" onclick="downloadSalesReport('pdf')" style="background: #212529;">Download PDF</button>
                <button class="p-2 text-white border-0" onclick="downloadSalesReport('excel')" style="background: #212529;">Download Excel</button>
            </div>

            <!-- Custom Date Range -->
            <div class="customDateRange" id="customDateRange" style="display: none;">
                <input type="date" id="startDate" class="me-2">
                <input type="date" id="endDate">
                <button class="btn btn-dark btn-sm rounded-0 btn-lg" onclick="generateCustomReport()">Generate Report</button>
                <p id="start-date-err" class="d-none text-danger fs-14">Please select a start date</p>
                <p id="end-date-err" class="d-none text-danger fs-14"></p>
            </div>

            <!-- Summary boxes -->
            <div class="row justify-content-center gap-2 mt-3">
                <div class="col-lg-4 bg-dark text-white text-center p-4">
                    <h5>Total Orders</h5>
                    <div><%= totalOrders %></div>
                </div>
                <div class="col-lg-4 bg-dark text-white text-center p-4">
                    <h5>Total Sales</h5>
                    <div><%= totalAmount %></div>
                </div>
                <div class="col-lg-4 bg-dark text-white text-center p-4">
                    <h5>Total Discount</h5>
                    <div><%= totalDiscount %></div>
                </div>
            </div>

            <!-- Table for sales report -->
            <div class="table-responsive border mt-5">
                <table class="table table-striped table-lg">
                    <thead>
                        <tr class="text text-center">
                            
                            <th scope="col">Date</th>
                            <th scope="col">Product Name</th>
                            <th scope="col">Image</th>
                            <th scope="col">Total</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Discount</th>
                            <th scope="col">Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.forEach((element)=>{ %>
                        <% element.products.forEach((item)=>{ %>
                        <tr class="text text-center"> 
                        <td><%= new Date(element.orderDate).toLocaleDateString('en-GB') %></td>
                        <td><%= item.name %></td>
                        <td><img src="/public/product_img/<%=item.image %>" alt=""></td>
                        <td><%= item.price %></td>
                        <td><%= item.quantity %></td>
                        <td><%= item.discounted_price %></td>
                        <td><%= element.paymentOption %></td>
                        </tr>
                        <% }) %>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function handleFilterChange() {
        const filterType = document.getElementById('filterType').value;
        const customDateRange = document.getElementById('customDateRange');

        if (filterType === 'custom') {
            customDateRange.style.display = 'block';
        } else {
            customDateRange.style.display = 'none';
            // Optionally reset the date inputs when not in custom mode
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            // Trigger report generation on filter change
            generateReport(filterType);
        }
    }

    function generateCustomReport() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // Ensure both dates are selected
        if (!startDate || !endDate) {
            if (!startDate) {
                document.getElementById('start-date-err').classList.remove('d-none');
            } else {
                document.getElementById('start-date-err').classList.add('d-none');
            }
            if (!endDate) {
                document.getElementById('end-date-err').innerText = 'Please select an end date';
                document.getElementById('end-date-err').classList.remove('d-none');
            } else {
                document.getElementById('end-date-err').classList.add('d-none');
            }
            return;
        }

        // Trigger report generation for custom range
        generateReport('custom', startDate, endDate);
    }

    function generateReport(filterType, startDate = '', endDate = '') {
        // Make an AJAX call to your backend with the filter parameters
        // You can use fetch or XMLHttpRequest here
        fetch(`/api/sales-report?filterType=${filterType}&startDate=${startDate}&endDate=${endDate}`)
            .then(response => response.json())
            .then(data => {
                // Update your table with new data here
                console.log(data); // for debugging
            })
            .catch(error => console.error('Error:', error));
    }
</script>


<%- include('../partials/adminFooter') %>
